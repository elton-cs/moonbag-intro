<!doctype html>

<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/src/styles.css" rel="stylesheet">
  </head>

  <body class="bg-gray-900 text-white min-h-screen p-8">
    <div class="max-w-md mx-auto space-y-6">
      <h1 class="text-3xl font-bold text-center mb-8">Spawn and Move</h1>

      <button id="controller-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Connect</button>

      <div class="space-y-4">
        <!-- Legacy Demo Stats -->
        <div class="bg-gray-800 p-4 rounded-lg space-y-2">
          <h3 class="text-lg font-semibold text-orange-400">Movement Demo</h3>
          <div id="position-display" class="text-sm font-mono">Position: (0, 0)</div>
          <div id="moves-display" class="text-sm font-mono">Moves remaining: 0</div>
        </div>

        <!-- Moon Bag Game Stats -->
        <div class="bg-gray-800 p-4 rounded-lg space-y-2">
          <h3 class="text-lg font-semibold text-purple-400">Moon Bag Game</h3>
          <div class="grid grid-cols-2 gap-2 text-sm font-mono">
            <div id="game-id-display">Game #0</div>
            <div id="level-display">Level: 1</div>
            <div id="health-display">Health: 5</div>
            <div id="points-display">Points: 0</div>
            <div id="multiplier-display">Multiplier: 1.0x</div>
            <div id="cheddah-display">Cheddah: 0</div>
            <div id="moon-rocks-display" class="col-span-2">Moon Rocks: 304</div>
          </div>
        </div>

        <div class="space-y-3">
          <button id="spawn-button" disabled class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">Spawn (Legacy)</button>
          <button id="spawn-game-button" disabled class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">Spawn Game</button>
          <button id="move-random-button" disabled class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">Move Random</button>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div></div>
          <button id="up-button" disabled class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">↑</button>
          <div></div>
          <button id="left-button" disabled class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">←</button>
          <div></div>
          <button id="right-button" disabled class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">→</button>
          <div></div>
          <button id="down-button" disabled class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition-colors">↓</button>
          <div></div>
        </div>
      </div>
    </div>

    <script type="module">
      import init, { ToriiClient } from './pkg/dojo_c.js';
      import { initGame, updateFromEntityData } from './game.js';
      import controllerOpts from './controller.js';
      import Controller from '@cartridge/controller';
      import manifest from '../contracts/manifest_dev.json' assert { type: 'json' };

      await init();

      async function run(account) {
        let config = {
          toriiUrl: 'http://localhost:8080',
          relayUrl: '',
          worldAddress: manifest.world.address,
        };

        const torii = await new ToriiClient(config);

        initGame(account, manifest);

        const query = {
          pagination: {
            limit: 10,
            cursor: undefined,
            direction: 'Forward',
            order_by: [],
          },
          clause: undefined,
          no_hashed_keys: false,
          models: [],
          historical: false,
        };

        let entities = await torii.getEntities(query);
        console.log(entities);

        if (entities.items.length > 0) {
          entities.items.forEach((entity) => {
            updateFromEntityData(entity);
          });
        }

        const subscription = await torii.onEntityUpdated(
          {
            Keys: {
              keys: [undefined],
              pattern_matching: 'VariableLen',
              models: [],
            },
          },
          (entities) => {
            console.log(entities);
            updateFromEntityData(entities);
          },
        );

        // Keeps the subscription alive
        window.addEventListener('beforeunload', () => {
          if (subscription) {
            subscription.cancel();
          }
        });
      }

      const controller = new Controller(controllerOpts);

      document.getElementById('controller-button').onclick = async () => {
        try {
          let account = await controller.connect();

          document.getElementById('controller-button').textContent = 'Connected';
          document.getElementById('controller-button').className = 'w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors';

          document.getElementById('spawn-button').disabled = false;
          document.getElementById('spawn-game-button').disabled = false;

          run(account).catch((error) => {
            console.error(error);
          });
        } catch (error) {
          console.error('Failed to connect:', error);
          document.getElementById('controller-button').textContent = 'Connection Failed';
          document.getElementById('controller-button').className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors';
        }
      };
    </script>
  </body>
</html>
